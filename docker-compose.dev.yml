# Integration testing stack for inventree-mcp-plugin
#
# Spins up a disposable InvenTree instance with the plugin volume-mounted.
# All state lives in named volumes that are destroyed on `down -v`.
#
# Quick start:
#   docker compose -f docker-compose.dev.yml up -d
#   docker compose -f docker-compose.dev.yml run --rm inventree-server invoke dev.setup-test -i
#   # MCP endpoint: http://localhost:8000/plugin/inventree-mcp/mcp/
#   docker compose -f docker-compose.dev.yml down -v

services:
  inventree-db:
    image: postgres:17
    container_name: inventree-test-db
    expose:
      - 5432/tcp
    environment:
      PGDATA: /var/lib/postgresql/data/pgdb
      POSTGRES_USER: pguser
      POSTGRES_PASSWORD: pgpassword
      POSTGRES_DB: inventree
    volumes:
      - inventree-test-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pguser -d inventree"]
      interval: 5s
      timeout: 5s
      retries: 5

  inventree-cache:
    image: redis:7-alpine
    container_name: inventree-test-cache
    expose:
      - 6379
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  inventree-server:
    image: inventree/inventree:${INVENTREE_TAG:-stable}
    container_name: inventree-test-server
    ports:
      - "${INVENTREE_PORT:-8000}:8000"
    depends_on:
      inventree-db:
        condition: service_healthy
      inventree-cache:
        condition: service_healthy
    environment:
      # Core
      INVENTREE_DEBUG: "True"
      INVENTREE_LOG_LEVEL: "WARNING"
      INVENTREE_AUTO_UPDATE: "True"
      INVENTREE_SECRET_KEY: "test-secret-key-for-integration-testing-only"
      INVENTREE_SITE_URL: "http://localhost:8000"
      INVENTREE_ALLOWED_HOSTS: "*"
      INVENTREE_CORS_ORIGIN_ALLOW_ALL: "True"
      # Database
      INVENTREE_DB_ENGINE: "postgresql"
      INVENTREE_DB_NAME: "inventree"
      INVENTREE_DB_HOST: "inventree-test-db"
      INVENTREE_DB_PORT: "5432"
      INVENTREE_DB_USER: "pguser"
      INVENTREE_DB_PASSWORD: "pgpassword"
      # Cache
      INVENTREE_CACHE_ENABLED: "True"
      INVENTREE_CACHE_HOST: "inventree-test-cache"
      INVENTREE_CACHE_PORT: "6379"
      # Admin (auto-created on first run)
      INVENTREE_ADMIN_USER: "admin"
      INVENTREE_ADMIN_PASSWORD: "inventree"
      INVENTREE_ADMIN_EMAIL: "admin@example.com"
      # Plugins
      INVENTREE_PLUGINS_ENABLED: "True"
      INVENTREE_PLUGIN_NOINSTALL: "False"
      INVENTREE_PLUGIN_DIR: "/home/inventree/data/plugins"
    volumes:
      - inventree-test-data:/home/inventree/data
      - ./:/home/inventree/data/plugins/inventree-mcp-plugin:ro

  inventree-worker:
    image: inventree/inventree:${INVENTREE_TAG:-stable}
    container_name: inventree-test-worker
    command: invoke worker
    depends_on:
      - inventree-server
    environment:
      INVENTREE_DEBUG: "True"
      INVENTREE_LOG_LEVEL: "WARNING"
      INVENTREE_SECRET_KEY: "test-secret-key-for-integration-testing-only"
      INVENTREE_DB_ENGINE: "postgresql"
      INVENTREE_DB_NAME: "inventree"
      INVENTREE_DB_HOST: "inventree-test-db"
      INVENTREE_DB_PORT: "5432"
      INVENTREE_DB_USER: "pguser"
      INVENTREE_DB_PASSWORD: "pgpassword"
      INVENTREE_CACHE_ENABLED: "True"
      INVENTREE_CACHE_HOST: "inventree-test-cache"
      INVENTREE_CACHE_PORT: "6379"
      INVENTREE_PLUGINS_ENABLED: "True"
      INVENTREE_PLUGIN_DIR: "/home/inventree/data/plugins"
    volumes:
      - inventree-test-data:/home/inventree/data
      - ./:/home/inventree/data/plugins/inventree-mcp-plugin:ro

volumes:
  inventree-test-data:
  inventree-test-pgdata:
